/*
 *                                 Apache License
 *                           version 2.0, january 2004
 *                        http://www.apache.org/licenses/
 *
 *   terms and conditions for use, reproduction, and distribution
 *
 *   1. definitions.
 *
 *      "license" shall mean the terms and conditions for use, reproduction,
 *      and distribution as defined by sections 1 through 9 of this document.
 *
 *      "licensor" shall mean the copyright owner or entity authorized by
 *      the copyright owner that is granting the license.
 *
 *      "legal entity" shall mean the union of the acting entity and all
 *      other entities that control, are controlled by, or are under common
 *      control with that entity. for the purposes of this definition,
 *      "control" means (i) the power, direct or indirect, to cause the
 *      direction or management of such entity, whether by contract or
 *      otherwise, or (ii) ownership of fifty percent (50%) or more of the
 *      outstanding shares, or (iii) beneficial ownership of such entity.
 *
 *      "you" (or "your") shall mean an individual or legal entity
 *      exercising permissions granted by this license.
 *
 *      "source" form shall mean the preferred form for making modifications,
 *      including but not limited to software source code, documentation
 *      source, and configuration files.
 *
 *      "object" form shall mean any form resulting from mechanical
 *      transformation or translation of a source form, including but
 *      not limited to compiled object code, generated documentation,
 *      and conversions to other media types.
 *
 *      "work" shall mean the work of authorship, whether in source or
 *      object form, made available under the license, as indicated by a
 *      copyright notice that is included in or attached to the work
 *      (an example is provided in the appendix below).
 *
 *      "derivative works" shall mean any work, whether in source or object
 *      form, that is based on (or derived from) the work and for which the
 *      editorial revisions, annotations, elaborations, or other modifications
 *      represent, as a whole, an original work of authorship. for the purposes
 *      of this license, derivative works shall not include works that remain
 *      separable from, or merely link (or bind by name) to the interfaces of,
 *      the work and derivative works thereof.
 *
 *      "contribution" shall mean any work of authorship, including
 *      the original version of the work and any modifications or additions
 *      to that work or derivative works thereof, that is intentionally
 *      submitted to licensor for inclusion in the work by the copyright owner
 *      or by an individual or legal entity authorized to submit on behalf of
 *      the copyright owner. for the purposes of this definition, "submitted"
 *      means any form of electronic, verbal, or written communication sent
 *      to the licensor or its representatives, including but not limited to
 *      communication on electronic mailing lists, source code control systems,
 *      and issue tracking systems that are managed by, or on behalf of, the
 *      licensor for the purpose of discussing and improving the work, but
 *      excluding communication that is conspicuously marked or otherwise
 *      designated in writing by the copyright owner as "not a contribution."
 *
 *      "contributor" shall mean licensor and any individual or legal entity
 *      on behalf of whom a contribution has been received by licensor and
 *      subsequently incorporated within the work.
 *
 *   2. grant of copyright license. subject to the terms and conditions of
 *      this license, each contributor hereby grants to you a perpetual,
 *      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *      copyright license to reproduce, prepare derivative works of,
 *      publicly display, publicly perform, sublicense, and distribute the
 *      work and such derivative works in source or object form.
 *
 *   3. grant of patent license. subject to the terms and conditions of
 *      this license, each contributor hereby grants to you a perpetual,
 *      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *      (except as stated in this section) patent license to make, have made,
 *      use, offer to sell, sell, import, and otherwise transfer the work,
 *      where such license applies only to those patent claims licensable
 *      by such contributor that are necessarily infringed by their
 *      contribution(s) alone or by combination of their contribution(s)
 *      with the work to which such contribution(s) was submitted. if you
 *      institute patent litigation against any entity (including a
 *      cross-claim or counterclaim in a lawsuit) alleging that the work
 *      or a contribution incorporated within the work constitutes direct
 *      or contributory patent infringement, then any patent licenses
 *      granted to you under this license for that work shall terminate
 *      as of the date such litigation is filed.
 *
 *   4. redistribution. you may reproduce and distribute copies of the
 *      work or derivative works thereof in any medium, with or without
 *      modifications, and in source or object form, provided that you
 *      meet the following conditions:
 *
 *      (a) you must give any other recipients of the work or
 *          derivative works a copy of this license; and
 *
 *      (b) you must cause any modified files to carry prominent notices
 *          stating that you changed the files; and
 *
 *      (c) you must retain, in the source form of any derivative works
 *          that you distribute, all copyright, patent, trademark, and
 *          attribution notices from the source form of the work,
 *          excluding those notices that do not pertain to any part of
 *          the derivative works; and
 *
 *      (d) if the work includes a "notice" text file as part of its
 *          distribution, then any derivative works that you distribute must
 *          include a readable copy of the attribution notices contained
 *          within such notice file, excluding those notices that do not
 *          pertain to any part of the derivative works, in at least one
 *          of the following places: within a notice text file distributed
 *          as part of the derivative works; within the source form or
 *          documentation, if provided along with the derivative works; or,
 *          within a display generated by the derivative works, if and
 *          wherever such third-party notices normally appear. the contents
 *          of the notice file are for informational purposes only and
 *          do not modify the license. you may add your own attribution
 *          notices within derivative works that you distribute, alongside
 *          or as an addendum to the notice text from the work, provided
 *          that such additional attribution notices cannot be construed
 *          as modifying the license.
 *
 *      you may add your own copyright statement to your modifications and
 *      may provide additional or different license terms and conditions
 *      for use, reproduction, or distribution of your modifications, or
 *      for any such derivative works as a whole, provided your use,
 *      reproduction, and distribution of the work otherwise complies with
 *      the conditions stated in this license.
 *
 *   5. submission of contributions. unless you explicitly state otherwise,
 *      any contribution intentionally submitted for inclusion in the work
 *      by you to the licensor shall be under the terms and conditions of
 *      this license, without any additional terms or conditions.
 *      notwithstanding the above, nothing herein shall supersede or modify
 *      the terms of any separate license agreement you may have executed
 *      with licensor regarding such contributions.
 *
 *   6. trademarks. this license does not grant permission to use the trade
 *      names, trademarks, service marks, or product names of the licensor,
 *      except as required for reasonable and customary use in describing the
 *      origin of the work and reproducing the content of the notice file.
 *
 *   7. disclaimer of warranty. unless required by applicable law or
 *      agreed to in writing, licensor provides the work (and each
 *      contributor provides its contributions) on an "as is" basis,
 *      without warranties or conditions of any kind, either express or
 *      implied, including, without limitation, any warranties or conditions
 *      of title, non-infringement, merchantability, or fitness for a
 *      particular purpose. you are solely responsible for determining the
 *      appropriateness of using or redistributing the work and assume any
 *      risks associated with your exercise of permissions under this license.
 *
 *   8. limitation of liability. in no event and under no legal theory,
 *      whether in tort (including negligence), contract, or otherwise,
 *      unless required by applicable law (such as deliberate and grossly
 *      negligent acts) or agreed to in writing, shall any contributor be
 *      liable to you for damages, including any direct, indirect, special,
 *      incidental, or consequential damages of any character arising as a
 *      result of this license or out of the use or inability to use the
 *      work (including but not limited to damages for loss of goodwill,
 *      work stoppage, computer failure or malfunction, or any and all
 *      other commercial damages or losses), even if such contributor
 *      has been advised of the possibility of such damages.
 *
 *   9. accepting warranty or additional liability. while redistributing
 *      the work or derivative works thereof, you may choose to offer,
 *      and charge a fee for, acceptance of support, warranty, indemnity,
 *      or other liability obligations and/or rights consistent with this
 *      license. however, in accepting such obligations, you may act only
 *      on your own behalf and on your sole responsibility, not on behalf
 *      of any other contributor, and only if you agree to indemnify,
 *      defend, and hold each contributor harmless for any liability
 *      incurred by, or claims asserted against, such contributor by reason
 *      of your accepting any such warranty or additional liability.
 *
 *   end of terms and conditions
 *
 *   appendix: how to apply the apache license to your work.
 *
 *      to apply the apache license to your work, attach the following
 *      boilerplate notice, with the fields enclosed by brackets "[]"
 *      replaced with your own identifying information. (don't include
 *      the brackets!)  the text should be enclosed in the appropriate
 *      comment syntax for the file format. we also recommend that a
 *      file or class name and description of purpose be included on the
 *      same "printed page" as the copyright notice for easier
 *      identification within third-party archives.
 *
 *   copyright [yyyy] [name of copyright owner]
 *
 *   licensed under the apache license, version 2.0 (the "license");
 *   you may not use this file except in compliance with the license.
 *   you may obtain a copy of the license at
 *
 *       http://www.apache.org/licenses/license-2.0
 *
 *   unless required by applicable law or agreed to in writing, software
 *   distributed under the license is distributed on an "as is" basis,
 *   without warranties or conditions of any kind, either express or implied.
 *   see the license for the specific language governing permissions and
 *   limitations under the License.
 *
 */
package dublin.temp;

import java.io.IOException;
import java.net.URI;
import java.nio.channels.SeekableByteChannel;
import java.nio.file.AccessMode;
import java.nio.file.CopyOption;
import java.nio.file.DirectoryStream;
import java.nio.file.DirectoryStream.Filter;
import java.nio.file.FileStore;
import java.nio.file.FileSystem;
import java.nio.file.LinkOption;
import java.nio.file.OpenOption;
import java.nio.file.Path;
import java.nio.file.Files;
import java.nio.file.attribute.BasicFileAttributes;
import java.nio.file.attribute.FileAttribute;
import java.nio.file.attribute.FileAttributeView;
import java.nio.file.spi.FileSystemProvider;
import java.util.Map;
import java.util.Set;

/**
 * @author marioggar
 *
 */
public class TemporaryFileSystemProvider extends FileSystemProvider {

    static final String SCHEME = "tmp";
    static FileSystem NON_THREAD_SAFE_FILE_SYSTEM;

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#getScheme()
	 */
	@Override
	public String getScheme() {
		return SCHEME;
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#newFileSystem(java.net.URI, java.util.Map)
	 */
	@Override
	public FileSystem newFileSystem(URI uri, Map<String, ?> env) throws IOException {

        String passedScheme = uri.getScheme();

        if(!passedScheme.equals(SCHEME)) {
            throw new IOException("Can't create a temporal file system from the given URI: " + passedScheme);
        }

        if (NON_THREAD_SAFE_FILE_SYSTEM == null) {
            NON_THREAD_SAFE_FILE_SYSTEM = new TemporaryFileSystem(this);
        }

        return NON_THREAD_SAFE_FILE_SYSTEM;

	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#getFileSystem(java.net.URI)
	 */
	@Override
	public FileSystem getFileSystem(URI uri) {

		FileSystem fileSystem = null;

        try {

            fileSystem = newFileSystem(uri, null);

        } catch(IOException ex) {
            ex.printStackTrace();
        }

        return fileSystem;

	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#getPath(java.net.URI)
	 */
	@Override
	public Path getPath(URI uri) {
		return new TemporaryPath(uri, NON_THREAD_SAFE_FILE_SYSTEM);
	}

	@Override
	public SeekableByteChannel newByteChannel(Path path,
			Set<? extends OpenOption> options, FileAttribute<?>... attrs)
			throws IOException {
        return Files.newByteChannel(path, options, attrs);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#newDirectoryStream(java.nio.file.Path, java.nio.file.DirectoryStream.Filter)
	 */
	@Override
	public DirectoryStream<Path> newDirectoryStream(Path dir,
			Filter<? super Path> filter) throws IOException {
        return Files.newDirectoryStream(dir, filter);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#createDirectory(java.nio.file.Path, java.nio.file.attribute.FileAttribute[])
	 */
	@Override
	public void createDirectory(Path dir, FileAttribute<?>... attrs)
			throws IOException {
        Files.createDirectory(dir, attrs);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#delete(java.nio.file.Path)
	 */
	@Override
	public void delete(Path path) throws IOException {
        Files.delete(path);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#copy(java.nio.file.Path, java.nio.file.Path, java.nio.file.CopyOption[])
	 */
	@Override
	public void copy(Path source, Path target, CopyOption... options)
			throws IOException {
        Files.copy(source, target, options);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#move(java.nio.file.Path, java.nio.file.Path, java.nio.file.CopyOption[])
	 */
	@Override
	public void move(Path source, Path target, CopyOption... options)
			throws IOException {
        Files.move(source, target, options);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#isSameFile(java.nio.file.Path, java.nio.file.Path)
	 */
	@Override
	public boolean isSameFile(Path path, Path path2) throws IOException {
        return Files.isSameFile(path, path2);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#isHidden(java.nio.file.Path)
	 */
	@Override
	public boolean isHidden(Path path) throws IOException {
        return Files.isHidden(path);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#getFileStore(java.nio.file.Path)
	 */
	@Override
	public FileStore getFileStore(Path path) throws IOException {
        return Files.getFileStore(path);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#checkAccess(java.nio.file.Path, java.nio.file.AccessMode[])
	 */
	@Override
	public void checkAccess(Path path, AccessMode... modes) throws IOException {

	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#getFileAttributeView(java.nio.file.Path, java.lang.Class, java.nio.file.LinkOption[])
	 */
	@Override
	public <V extends FileAttributeView> V getFileAttributeView(Path path,
			Class<V> type, LinkOption... options) {
        return Files.getFileAttributeView(path, type, options);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#readAttributes(java.nio.file.Path, java.lang.Class, java.nio.file.LinkOption[])
	 */
	@Override
	public <A extends BasicFileAttributes> A readAttributes(Path path,
			Class<A> type, LinkOption... options) throws IOException {
        return Files.readAttributes(path, type, options);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#readAttributes(java.nio.file.Path, java.lang.String, java.nio.file.LinkOption[])
	 */
	@Override
	public Map<String, Object> readAttributes(Path path, String attributes,
			LinkOption... options) throws IOException {
        return Files.readAttributes(path, attributes, options);
	}

	/* (non-Javadoc)
	 * @see java.nio.file.spi.FileSystemProvider#setAttribute(java.nio.file.Path, java.lang.String, java.lang.Object, java.nio.file.LinkOption[])
	 */
	@Override
	public void setAttribute(Path path, String attribute, Object value,
			LinkOption... options) throws IOException {
        Files.setAttribute(path, attribute, value, options);
	}

}
